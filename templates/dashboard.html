<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ –ú–æ—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-music me-2"></i>
                {{ user.first_name or user.username }}'s –ú—É–∑—ã–∫–∞
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-user me-1"></i>
                    {{ user.first_name or user.username or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
            <div class="col-lg-2 col-md-3">
                <div class="sidebar bg-light p-3 rounded">
                    <h6 class="text-muted mb-3">–ù–ê–í–ò–ì–ê–¶–ò–Ø</h6>
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('all-tracks')">
                                <i class="fas fa-music me-2"></i>–í—Å–µ —Ç—Ä–µ–∫–∏
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('albums')">
                                <i class="fas fa-compact-disc me-2"></i>–ê–ª—å–±–æ–º—ã
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('playlists')">
                                <i class="fas fa-list me-2"></i>–ü–ª–µ–π–ª–∏—Å—Ç—ã
                            </a>
                        </li>
                    </ul>
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="mt-4">
                        <h6 class="text-muted mb-3">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</h6>
                        <div id="stats-container">
                            <div class="stat-item d-flex justify-content-between">
                                <span>–¢—Ä–µ–∫–æ–≤:</span>
                                <span id="stats-tracks">{{ all_tracks|length }}</span>
                            </div>
                            <div class="stat-item d-flex justify-content-between">
                                <span>–ê–ª—å–±–æ–º–æ–≤:</span>
                                <span id="stats-albums">{{ albums|length }}</span>
                            </div>
                            <div class="stat-item d-flex justify-content-between">
                                <span>–ü–ª–µ–π–ª–∏—Å—Ç–æ–≤:</span>
                                <span id="stats-playlists">{{ playlists|length }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="col-lg-10 col-md-9">
                <!-- –ü–ª–µ–µ—Ä -->
                <div class="player-section mb-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <div class="track-info">
                                        <div id="current-track-title" class="fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫</div>
                                        <div id="current-track-artist" class="text-muted small">–¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="player-controls text-center">
                                        <button class="btn btn-outline-primary me-2" onclick="previousTrack()">
                                            <i class="fas fa-step-backward"></i>
                                        </button>
                                        <button id="play-pause-btn" class="btn btn-primary btn-lg me-2" onclick="togglePlayPause()">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn btn-outline-primary me-2" onclick="nextTrack()">
                                            <i class="fas fa-step-forward"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="toggleShuffle()">
                                            <i id="shuffle-icon" class="fas fa-random"></i>
                                        </button>
                                    </div>
                                    <div class="progress mt-2">
                                        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="volume-control">
                                        <i class="fas fa-volume-up me-2"></i>
                                        <input type="range" id="volume-slider" class="form-range" min="0" max="100" value="50">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div id="time-display" class="text-end">
                                        <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –≤—Å–µ—Ö —Ç—Ä–µ–∫–æ–≤ -->
                <div id="all-tracks-section" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-music me-2"></i>–í—Å–µ —Ç—Ä–µ–∫–∏</h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="playAllTracks()">
                                <i class="fas fa-play me-1"></i>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤—Å–µ
                            </button>
                            <button class="btn btn-outline-secondary" onclick="shuffleAllTracks()">
                                <i class="fas fa-random me-1"></i>–ü–µ—Ä–µ–º–µ—à–∞—Ç—å
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>–¢—Ä–µ–∫</th>
                                    <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                                    <th>–ê–ª—å–±–æ–º/–ü–ª–µ–π–ª–∏—Å—Ç</th>
                                    <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                    <th style="width: 80px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="tracks-table-body">
                                {% for track in all_tracks %}
                                <tr data-track-id="{{ track.id }}">
                                    <td>
                                        <button class="btn btn-sm btn-outline-success" onclick="playTrack({{ track.id }})">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </td>
                                    <td class="fw-medium">{{ track.title }}</td>
                                    <td class="text-muted">{{ track.artist }}</td>
                                    <td class="text-muted small">
                                        {% if track.album %}
                                            üìÄ {{ track.album.name }}
                                        {% elif track.playlist %}
                                            üìù {{ track.playlist.name }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-muted">
                                        {% if track.duration %}
                                            {{ "%d:%02d"|format(track.duration // 60, track.duration % 60) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTrack({{ track.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –∞–ª—å–±–æ–º–æ–≤ -->
                <div id="albums-section" class="content-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-compact-disc me-2"></i>–ê–ª—å–±–æ–º—ã</h4>
                    </div>
                    <div class="row" id="albums-container">
                        {% for album in albums %}
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-4" data-album-id="{{ album.id }}">
                            <div class="card album-card h-100">
                                <div class="card-body">
                                    <div class="album-cover mb-3 text-center">
                                        <i class="fas fa-compact-disc fa-3x text-primary"></i>
                                    </div>
                                    <h6 class="card-title">{{ album.name }}</h6>
                                    {% if album.description %}
                                    <p class="card-text text-muted small">{{ album.description }}</p>
                                    {% endif %}
                                    <p class="card-text small">
                                        {% set track_count = album.tracks|length %}
                                        {{ track_count }} {{ "—Ç—Ä–µ–∫" if track_count == 1 else "—Ç—Ä–µ–∫–æ–≤" if track_count < 5 else "—Ç—Ä–µ–∫–æ–≤" }}
                                    </p>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-primary flex-fill" onclick="playAlbum({{ album.id }})">
                                            <i class="fas fa-play me-1"></i>–ò–≥—Ä–∞—Ç—å
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAlbum({{ album.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ -->
                <div id="playlists-section" class="content-section d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-list me-2"></i>–ü–ª–µ–π–ª–∏—Å—Ç—ã</h4>
                    </div>
                    <div class="row" id="playlists-container">
                        {% for playlist in playlists %}
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-4" data-playlist-id="{{ playlist.id }}">
                            <div class="card playlist-card h-100">
                                <div class="card-body">
                                    <div class="playlist-cover mb-3 text-center">
                                        <i class="fas fa-list fa-3x text-success"></i>
                                    </div>
                                    <h6 class="card-title">{{ playlist.name }}</h6>
                                    {% if playlist.description %}
                                    <p class="card-text text-muted small">{{ playlist.description }}</p>
                                    {% endif %}
                                    <p class="card-text small">
                                        {% set track_count = playlist.tracks|length %}
                                        {{ track_count }} {{ "—Ç—Ä–µ–∫" if track_count == 1 else "—Ç—Ä–µ–∫–æ–≤" if track_count < 5 else "—Ç—Ä–µ–∫–æ–≤" }}
                                    </p>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-success flex-fill" onclick="playPlaylist({{ playlist.id }})">
                                            <i class="fas fa-play me-1"></i>–ò–≥—Ä–∞—Ç—å
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePlaylist({{ playlist.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç -->
    <audio id="audio-player" preload="none"></audio>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/music-player.js') }}"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–µ–µ—Ä–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const TELEGRAM_ID = {{ telegram_id }};
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initializeMusicPlayer(TELEGRAM_ID);
            loadUserStats();
        });
    </script>
</body>
</html>